name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Static Analysis
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.lint.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Android Lint
        id: lint
        run: ./gradlew lint --no-daemon

      - name: Upload Lint Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: lint-results
          path: |
            **/build/reports/lint-results*.html
            **/build/reports/lint-results*.xml
          retention-days: 14

  detekt:
    name: Detekt Static Analysis
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.detekt.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Detekt
        id: detekt
        run: ./gradlew detekt --no-daemon
        continue-on-error: true

      - name: Upload Detekt Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: detekt-results
          path: '**/build/reports/detekt/**'
          retention-days: 14

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.tests.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Unit Tests
        id: tests
        run: ./gradlew testDebugUnitTest --no-daemon

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results
          path: '**/build/reports/tests/**'
          retention-days: 14

      - name: Upload Test Reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-reports
          path: '**/build/test-results/**'
          retention-days: 14

  build-debug:
    name: Build Debug APK
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    outputs:
      status: ${{ steps.build.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Debug APK
        id: build
        run: ./gradlew assembleDebug --no-daemon

      - name: Get APK info
        id: apk-info
        run: |
          APK_DIR="app/build/outputs/apk/debug"
          if [ -d "$APK_DIR" ]; then
            APK_LIST=""
            for apk in "$APK_DIR"/*.apk; do
              if [ -f "$apk" ]; then
                SIZE=$(du -h "$apk" | cut -f1)
                NAME=$(basename "$apk")
                APK_LIST="${APK_LIST}| \`${NAME}\` | ${SIZE} |\n"
              fi
            done
            echo "apk_list<<EOF" >> $GITHUB_OUTPUT
            echo -e "$APK_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "apk_count=$(ls -1 "$APK_DIR"/*.apk 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          fi

      - name: Upload Debug APKs
        uses: actions/upload-artifact@v6
        with:
          name: debug-apks
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 14

  pr-comment:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: [lint, detekt, unit-tests, build-debug]
    if: github.event_name == 'pull_request' && always()
    
    steps:
      - name: Comment PR with build summary
        uses: actions/github-script@v8
        with:
          script: |
            const lintStatus = '${{ needs.lint.outputs.status }}' || '${{ needs.lint.result }}';
            const detektStatus = '${{ needs.detekt.outputs.status }}' || '${{ needs.detekt.result }}';
            const testStatus = '${{ needs.unit-tests.outputs.status }}' || '${{ needs.unit-tests.result }}';
            const buildStatus = '${{ needs.build-debug.outputs.status }}' || '${{ needs.build-debug.result }}';
            
            const getEmoji = (status) => {
              if (status === 'success') return '‚úÖ';
              if (status === 'failure') return '‚ùå';
              if (status === 'skipped') return '‚è≠Ô∏è';
              return '‚ö†Ô∏è';
            };
            
            const getStatus = (status) => {
              if (status === 'success') return 'Passed';
              if (status === 'failure') return 'Failed';
              if (status === 'skipped') return 'Skipped';
              return status || 'Unknown';
            };
            
            const artifactsUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            
            const body = `## ü§ñ CI Build Summary
            
            | Check | Status |
            |-------|--------|
            | ${getEmoji(lintStatus)} **Lint** | ${getStatus(lintStatus)} |
            | ${getEmoji(detektStatus)} **Detekt** | ${getStatus(detektStatus)} |
            | ${getEmoji(testStatus)} **Unit Tests** | ${getStatus(testStatus)} |
            | ${getEmoji(buildStatus)} **Build** | ${getStatus(buildStatus)} |
            
            ### üì¶ Artifacts
            
            ${buildStatus === 'success' ? `**Debug APKs are ready for download!**
            
            | APK | Architecture |
            |-----|--------------|
            | \`termux-app_*_arm64-v8a.apk\` | ARM64 (most devices) |
            | \`termux-app_*_armeabi-v7a.apk\` | ARM32 (older devices) |
            | \`termux-app_*_x86_64.apk\` | x86_64 (emulators) |
            | \`termux-app_*_x86.apk\` | x86 (older emulators) |
            | \`termux-app_*_universal.apk\` | All architectures |
            
            üëâ [**Download Artifacts**](${artifactsUrl})` : '‚ö†Ô∏è Build did not complete successfully. Check the workflow logs.'}
            
            ---
            <sub>üî® Built from commit \`${context.sha.substring(0, 7)}\` | [View workflow run](${artifactsUrl})</sub>`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ü§ñ CI Build Summary')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
