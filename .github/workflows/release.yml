name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.8)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref }}

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Lint
        run: ./gradlew lint --no-daemon

      - name: Run Unit Tests
        run: ./gradlew testDebugUnitTest --no-daemon

  build-release:
    name: Build Release APK
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref }}

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > app/termux-release.keystore

      - name: Create signing.properties
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          cat > signing.properties << EOF
          storeFile=termux-release.keystore
          storePassword=$KEYSTORE_PASSWORD
          keyAlias=$KEY_ALIAS
          keyPassword=$KEY_PASSWORD
          EOF

      - name: Build Release APK (Split)
        env:
          TERMUX_SPLIT_APKS_FOR_RELEASE_BUILDS: "1"
        run: ./gradlew assembleRelease --no-daemon

      - name: List APKs
        run: ls -la app/build/outputs/apk/release/

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Get previous tag
        id: prev_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            CURRENT_TAG="${{ inputs.tag }}"
          else
            CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          fi
          PREV_TAG=$(git tag -l 'v*' --sort=-v:refname | grep -v "^${CURRENT_TAG}$" | head -n1)
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"

      - name: Generate changelog from commits
        id: changelog
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            CURRENT_TAG="${{ inputs.tag }}"
          else
            CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          fi
          PREV_TAG="${{ steps.prev_tag.outputs.tag }}"
          
          echo "Generating changelog from $PREV_TAG to $CURRENT_TAG"
          
          # Generate changelog grouped by type
          {
            echo "CHANGELOG<<EOF"
            
            # Features
            FEATURES=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" | grep -iE "^feat(\(.+\))?:" | sed 's/^feat(\([^)]*\)):/- **\1:**/' | sed 's/^feat:/- /' || true)
            if [ -n "$FEATURES" ]; then
              echo "### âœ¨ Features"
              echo "$FEATURES"
              echo ""
            fi
            
            # Bug fixes
            FIXES=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" | grep -iE "^fix(\(.+\))?:" | sed 's/^fix(\([^)]*\)):/- **\1:**/' | sed 's/^fix:/- /' || true)
            if [ -n "$FIXES" ]; then
              echo "### ðŸ› Bug Fixes"
              echo "$FIXES"
              echo ""
            fi
            
            # Performance
            PERF=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" | grep -iE "^perf(\(.+\))?:" | sed 's/^perf(\([^)]*\)):/- **\1:**/' | sed 's/^perf:/- /' || true)
            if [ -n "$PERF" ]; then
              echo "### âš¡ Performance"
              echo "$PERF"
              echo ""
            fi
            
            # Documentation
            DOCS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" | grep -iE "^docs(\(.+\))?:" | sed 's/^docs(\([^)]*\)):/- **\1:**/' | sed 's/^docs:/- /' || true)
            if [ -n "$DOCS" ]; then
              echo "### ðŸ“š Documentation"
              echo "$DOCS"
              echo ""
            fi
            
            # CI/Build
            CI=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" | grep -iE "^(ci|build|chore)(\(.+\))?:" | sed 's/^ci(\([^)]*\)):/- **\1:**/' | sed 's/^ci:/- /' | sed 's/^build(\([^)]*\)):/- **\1:**/' | sed 's/^build:/- /' | sed 's/^chore(\([^)]*\)):/- **\1:**/' | sed 's/^chore:/- /' || true)
            if [ -n "$CI" ]; then
              echo "### ðŸ”§ Maintenance"
              echo "$CI"
              echo ""
            fi
            
            # Other commits (not matching conventional commits)
            OTHER=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" | grep -viE "^(feat|fix|perf|docs|ci|build|chore|refactor|test|style)(\(.+\))?:" | grep -v "^Merge" | head -10 | sed 's/^/- /' || true)
            if [ -n "$OTHER" ]; then
              echo "### ðŸ“ Other Changes"
              echo "$OTHER"
              echo ""
            fi
            
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'RELEASE_EOF'
          ## ðŸš€ Termux Kotlin ${{ steps.get_version.outputs.VERSION }}
          
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ### ðŸ“¦ Downloads
          
          | Architecture | Recommended For |
          |-------------|-----------------|
          | `arm64-v8a` | **Most Android devices** (2017+) |
          | `armeabi-v7a` | Older 32-bit phones |
          | `x86_64` | Emulators, ChromeOS |
          | `x86` | Older emulators |
          | `universal` | All devices (larger file) |
          
          ### ðŸ“² Installation
          1. Download the APK for your architecture
          2. Enable "Install from unknown sources" if prompted
          3. Install and run Termux!
          
          ### âš ï¸ Note
          If you have Termux from F-Droid or Play Store, uninstall it first (different signature).
          
          ---
          *100% Kotlin â€¢ Built from commit ${{ github.sha }}*
          RELEASE_EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "ðŸš€ Termux Kotlin ${{ steps.get_version.outputs.VERSION }}"
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          files: |
            app/build/outputs/apk/release/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release APKs as Artifact
        uses: actions/upload-artifact@v6
        with:
          name: release-apks
          path: app/build/outputs/apk/release/*.apk
          retention-days: 90

  update-changelog:
    name: Update CHANGELOG.md
    runs-on: ubuntu-latest
    needs: build-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: main

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Get previous tag
        id: prev_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            CURRENT_TAG="${{ inputs.tag }}"
          else
            CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          fi
          PREV_TAG=$(git tag -l 'v*' --sort=-v:refname | grep -v "^${CURRENT_TAG}$" | head -n1)
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Generate changelog entry
        id: changelog_entry
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            CURRENT_TAG="${{ inputs.tag }}"
          else
            CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          fi
          PREV_TAG="${{ steps.prev_tag.outputs.tag }}"
          DATE=$(date +%Y-%m-%d)
          
          {
            echo "ENTRY<<EOF"
            echo "## [$CURRENT_TAG] - $DATE"
            echo ""
            
            # Features
            FEATURES=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" | grep -iE "^feat(\(.+\))?:" | sed 's/^feat(\([^)]*\)):/- **\1:**/' | sed 's/^feat:/- /' || true)
            if [ -n "$FEATURES" ]; then
              echo "### âœ¨ Features"
              echo "$FEATURES"
              echo ""
            fi
            
            # Bug fixes
            FIXES=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" | grep -iE "^fix(\(.+\))?:" | sed 's/^fix(\([^)]*\)):/- **\1:**/' | sed 's/^fix:/- /' || true)
            if [ -n "$FIXES" ]; then
              echo "### ðŸ› Bug Fixes"
              echo "$FIXES"
              echo ""
            fi
            
            # Performance
            PERF=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" | grep -iE "^perf(\(.+\))?:" | sed 's/^perf(\([^)]*\)):/- **\1:**/' | sed 's/^perf:/- /' || true)
            if [ -n "$PERF" ]; then
              echo "### âš¡ Performance"
              echo "$PERF"
              echo ""
            fi
            
            # Documentation
            DOCS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" | grep -iE "^docs(\(.+\))?:" | sed 's/^docs(\([^)]*\)):/- **\1:**/' | sed 's/^docs:/- /' || true)
            if [ -n "$DOCS" ]; then
              echo "### ðŸ“š Documentation"
              echo "$DOCS"
              echo ""
            fi
            
            # CI/Build
            CI=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" | grep -iE "^(ci|build|chore)(\(.+\))?:" | sed 's/^ci(\([^)]*\)):/- **\1:**/' | sed 's/^ci:/- /' | sed 's/^build(\([^)]*\)):/- **\1:**/' | sed 's/^build:/- /' | sed 's/^chore(\([^)]*\)):/- **\1:**/' | sed 's/^chore:/- /' || true)
            if [ -n "$CI" ]; then
              echo "### ðŸ”§ Maintenance"
              echo "$CI"
              echo ""
            fi
            
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Update CHANGELOG.md
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          
          # Create CHANGELOG.md if it doesn't exist
          if [ ! -f CHANGELOG.md ]; then
            cat > CHANGELOG.md << 'HEADER'
          # Changelog
          
          All notable changes to Termux Kotlin will be documented in this file.
          
          The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
          
          HEADER
          fi
          
          # Check if this version already exists in changelog
          if grep -q "## \[$VERSION\]" CHANGELOG.md; then
            echo "Version $VERSION already in CHANGELOG.md, skipping update"
            exit 0
          fi
          
          # Insert new entry after the header
          ENTRY="${{ steps.changelog_entry.outputs.ENTRY }}"
          
          # Create temp file with new entry
          {
            head -n 7 CHANGELOG.md
            echo ""
            echo "$ENTRY"
            tail -n +8 CHANGELOG.md
          } > CHANGELOG.tmp
          mv CHANGELOG.tmp CHANGELOG.md

      - name: Commit and push CHANGELOG
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet CHANGELOG.md; then
            echo "No changes to CHANGELOG.md"
            exit 0
          fi
          
          git add CHANGELOG.md
          git commit -m "docs: Update CHANGELOG for ${{ steps.get_version.outputs.VERSION }} [skip ci]"
          git push origin main
